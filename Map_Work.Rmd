---
title: "Map_Work"
author: "Philipp Hoeper"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 2
---

```{r}
library(tidyverse)
library(glue)
library(plotly)
library(dygraphs)
library(xts)
library(reactable)
library(lubridate)
```

## Importing Data

```{r}
base_url <-
  paste0(
    "https://raw.githubusercontent.com/CSSEGISandData",
    "/COVID-19/master/csse_covid_19_data/",
    "csse_covid_19_daily_reports/"
  )

## currently just one day:
date_latest <-"04-30-2020"

extension <- ".csv"

url <- paste0(base_url, date_latest, extension)


```

COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series
https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series
base_url <-
  paste0('https://raw.githubusercontent.com/',
         'CSSEGISandData/COVID-19/master/',
         'csse_covid_19_data/csse_covid_19_time_series/')

## Importing time series data

```{r}
base_url <-
  paste0('https://raw.githubusercontent.com/CSSEGISandData',
    '/COVID-19/master/csse_covid_19_data/',
         'csse_covid_19_time_series/')

filename <- 
  paste0('time_series_covid19_', 
         c('confirmed_global', 'deaths_global', 'recovered_global'), '.csv')


url <- paste0(base_url, filename)
url
```


```{r}
Confirmed <- url[1] %>% 
  read_csv(col_types = cols(
    .default = col_double(),
    `Province/State` = col_character(),
    `Country/Region` = col_character()
  )) %>%
  rename(country_or_region = `Country/Region`)

Deaths <- url[2] %>% 
  read_csv(col_types = cols(
    .default = col_double(),
    `Province/State` = col_character(),
    `Country/Region` = col_character()
  )) %>%
  rename(country_or_region = `Country/Region`)

Recovered <- url[3] %>% 
  read_csv(col_types = cols(
    .default = col_double(),
    `Province/State` = col_character(),
    `Country/Region` = col_character()
  )) %>%
  rename(country_or_region = `Country/Region`)
```



## Manipulating Daily report data

```{r}
reactable::reactable(daily, searchable = TRUE,
                     pageSizeOptions = c(5, 10, 20), 
                     defaultPageSize = 5)
```
this data is for the US map which is not my focus but it is here for the sake of tips

```{r}
extra <- c(
  "Guam", "Grand Princess", "Virgin Islands, U.S.",
  "Diamond Princess", "Puerto Rico"
)
us <-
  us %>% 
  filter(!(Province_or_State %in% extra))
```

```{r}
data("statepop", package = "usmap")
glimpse(statepop)
```

```{r}
us <-
  us %>% 
  rename(full = Province_or_State) %>% 
  inner_join(statepop, by = "full") %>% 
  select(fips, abbr, full, Confirmed, Deaths, Recovered) %>% 
  mutate(hover = glue::glue(
    "{full}
     Deaths: {Deaths}
     Recovered:  {Recovered}"
  ))
```

Here is the states map once again just for reference a
```{r}
# give state boundaries a red border
lcol <- list(color = toRGB("red"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

fig <- plot_geo(us, locationmode = 'USA-states',
                marker = list(line = lcol))
fig <- fig %>% add_trace(
  z = ~ Confirmed, text = ~hover, locations = ~abbr,
  color = ~ Confirmed, colors = 'Purples'
)
fig <- fig %>% colorbar(title = "Confirmed Cases")

fig <- fig %>% layout(
  title = paste0('Confirmed Cases, by State: ', date_latest),
  geo = g
)

fig
```


## World Map

Lets download a data file that has the nations codes on it 
```{r}
df <- read.csv('https://raw.githubusercontent.com/plotly/datasets/master/2014_world_gdp_with_codes.csv')


```
lets look at it
```{r}
glimpse(df)
```
for comparison lets look at the daily data set
```{r}
glimpse(daily)
```
just for the hell of it
```{r}
df <-
  df %>% 
  rename(land = COUNTRY)
```
now lets join the two and select the columns that we want, also make a hover tooltip

```{r}
daily <- read_csv(file = url) %>%
  rename(country_or_region = "Country_Region") %>%
  rename(Province_or_State = "Province_State") %>%
  group_by(country_or_region) %>%
  summarize(
    Deaths = sum(Deaths),
    Confirmed = sum(Confirmed),
    Recovered = sum(Recovered),
    Active = sum(Active)
  ) %>%
  rename(land = country_or_region) %>%
  mutate(
    land = plyr::mapvalues(
      land,
      from = c("US", "Taiwan*", "Bahamas", "Congo (Brazzaville)", "Congo (Kinshasa)", "	Gambia"),
      to = c("United States", "Taiwan", "Bahamas, The", "Congo, Republic of the", "Congo, Democratic Republic of the", "Gambia, The")
    )
  )
```
Now we have all the same country names apart from Swaziland which recently changed its name to Eswatini
So lets fix this

```{r}
df <-
  df %>% 
  mutate(
    land = plyr::mapvalues(
      land,
      from = c("Swaziland"),
      to = c("Eswatini")
    )
  ) 
```


```{r}
world <-
  daily %>% 
  right_join(df, by = "land") %>% 
  select(land, CODE, Confirmed, Deaths, Recovered, Active) %>% 
  mutate(hover = glue::glue(
    "{land}
     Deaths: {Deaths}
     Recovered:  {Recovered}"
  ))
```

Now plot time
```{r}
# light grey boundaries
l <- list(color = toRGB("grey"), width = 0.5)

# specify map projection/options
g <- list(
  showframe = FALSE,
  showcoastlines = FALSE,
  projection = list(type = 'Mercator')
)

fig <- plot_geo(world)
fig <- fig %>% add_trace(
    z = ~ Confirmed, color = ~ Confirmed, colors = 'Greens',
    text = ~ hover, locations = ~ CODE, marker = list(line = l)
  )
fig <- fig %>% colorbar(title = 'COVID-19 Cases')
fig <- fig %>% layout(
    title = paste0('Global COVID-19 Confirmed Cases as of: ',
                   date_latest),
    geo = g
  )

fig
```
As we can see, the map works but there is a problem for all countries that the data set splits into provinves or states, we need to find a way to change this and make the nations such as US and AUS a summation of their provinces.
Also we have a problem with US being used as the name of the USA in the covid data set which is not the same as the df data thus US didnt recieve a code hence it is missing in the map.


```{r}
world2 <-
  world %>% 
  select(-c(1))
```
as we can see if we delete the province row these seperate.

What we want is a way to sum these provinces.
